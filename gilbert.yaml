version: 1.0
vars:
  app_version: '1.0.0'
  build_dir: '{{PROJECT}}/build'
  lib_dir: '{{build_dir}}/lib'
  server_dir: './server'

mixins:
  build-lib:
    - description: 'build {{name}} library'
      action: build
      params:
        source: './sources/{{name}}'
        outputPath: '{{lib_dir}}/{{name}}.so'
        buildMode: plugin
  build-clean:
    - if: '[ -d {{ build_dir }} ]'
      description: 'clean build directory'
      action: shell
      params:
        command: 'rm -rf {{build_dir}}'
  copy-assets:
    - if: '[ ! -d {{build_dir}} ]'
      description: 'create build directory'
      action: shell
      params:
        command: 'mkdir {{build_dir}}'
    - description: 'copy config file'
      action: shell
      params:
        command: 'cp {{server_dir}}/config.json {{build_dir}}/config.json'
    - description: 'copy assets'
      action: shell
      params:
        command: 'cp -rf {{server_dir}}/public {{build_dir}}/public'
  watch:
    - description: build server
      action: build
      params:
        source: '{{server_dir}}'
        outputPath: '{{build_dir}}/server'
    - mixin: build-lib
      vars:
        name: 'reddit'
    - mixin: build-lib
      vars:
        name: 'stackexchange'
    - action: shell
      params:
        workDir: '{{build_dir}}'
        command: '{{build_dir}}/server'

tasks:
  watch:
    - mixin: build-clean
    - mixin: copy-assets
    - action: watch
      params:
        path: './...'
        ignore:
          - 'docs/*'
          - 'build/*'
          - 'build/lib/*'
          - '.git'
          - 'go.mod'
          - 'go.sum'
        run:
          mixin: watch
  build:
    - mixin: build-clean
    - mixin: copy-assets
    - description: build server
      action: build
      params:
        source: '{{server_dir}}'
        outputPath: '{{build_dir}}/server'
    - mixin: build-lib
      vars:
        name: 'reddit'
    - mixin: build-lib
      vars:
        name: 'stackexchange'
  start:
    - if: '[ -f {{build_dir}}/server ]'
      action: shell
      params:
        command: '{{build_dir}}/server'
        workDir: '{{build_dir}}'
  clean:
  - mixin: build-clean
