version: 1.0
  
imports:
  - ./docs/common.yaml

plugins:
  - go://./docs/actions

vars:
  app_version: '1.0.0'
  build_dir: '{{PROJECT}}/build'
  lib_dir: '{{build_dir}}/lib'
  server_dir: './server'
  watcher_addr: 'localhost:4800'

mixins:
  build-server:
    - description: build server
      action: build
      params:
        source: '{{server_dir}}'
        outputPath: '{{build_dir}}/server'
        variables:
          'main.version': '{{app_version}}'
          'main.commit': '{% git log --format=%H -n 1 %}'
  
  build-libs:
    - mixin: build-lib
      vars:
        name: 'reddit'
    - mixin: build-lib
      vars:
        name: 'stackexchange'

  clean:
    - if: '[ -d {{ build_dir }} ]'
      description: 'clean build directory'
      action: shell
      params:
        command: 'rm -rf {{build_dir}}'

  copy-assets:
    - if: '[ ! -d {{build_dir}} ]'
      description: 'create build directory'
      action: shell
      params:
        command: 'mkdir {{build_dir}}'
    - description: 'copy config file'
      action: shell
      params:
        command: 'cp {{server_dir}}/config.json {{build_dir}}/config.json'
    - description: 'copy assets'
      action: shell
      params:
        command: 'cp -rf {{server_dir}}/public {{build_dir}}'

  rebuild:
    - mixin: build-server
    - mixin: build-libs
    - mixin: copy-assets
    - action: 'live-reload:trigger'
      params:
        address: '{{watcher_addr}}'
    - action: shell
      params:
        workDir: '{{build_dir}}'
        command: '{{build_dir}}/server'

tasks:
  build:
    - mixin: clean
    - mixin: copy-assets
    - mixin: build-server
    - mixin: build-libs
  cover:
    - action: cover
      params:
        threshold: 40
        reportCoverage: true
        packages:
          - ./sources/...
  watch:
    - mixin: clean
    - mixin: copy-assets
    - action: live-reload:start-server
      async: true
      params:
        address: '{{watcher_addr}}'
        timeout: 1500
    - action: watch
      params:
        path: './server/...'
        run:
          mixin: rebuild
  start:
    - if: '[ -f {{build_dir}}/server ]'
      action: shell
      params:
        command: '{{build_dir}}/server'
        workDir: '{{build_dir}}'
  clean:
  - mixin: build-clean
